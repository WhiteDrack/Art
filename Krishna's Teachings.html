<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ProInvoice - Smart Billing</title>
    
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --primary: #4f46e5;
            --primary-dark: #4338ca;
            --bg-body: #f3f4f6;
            --text-main: #111827;
            --text-muted: #6b7280;
            --sidebar-w: 260px;
            --header-h: 60px;
            --radius: 12px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', sans-serif; background: var(--bg-body); color: var(--text-main); height: 100vh; overflow: hidden; display: flex; }

        /* --- UTILITIES --- */
        .hidden { display: none !important; }
        .flex { display: flex; align-items: center; }
        .flex-between { display: flex; justify-content: space-between; align-items: center; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .w-100 { width: 100%; }
        .text-center { text-align: center; }
        .mt-2 { margin-top: 10px; }
        
        /* --- BUTTONS & INPUTS --- */
        .btn {
            background: var(--primary); color: white; border: none; padding: 12px 20px;
            border-radius: 8px; font-weight: 500; cursor: pointer; transition: 0.2s;
            display: inline-flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.95rem;
        }
        .btn:active { transform: scale(0.98); }
        .btn-outline { background: transparent; border: 1px solid #d1d5db; color: var(--text-main); }
        .btn-dashed { background: transparent; border: 2px dashed #d1d5db; color: var(--text-muted); }
        .btn-dashed:hover { border-color: var(--primary); color: var(--primary); background: #eef2ff; }
        .btn-danger { background: #ef4444; }
        .btn-success { background: #10b981; }
        .btn-dark { background: #1f2937; }
        
        input, select, textarea {
            width: 100%; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px;
            font-size: 0.95rem; background: #f9fafb; transition: 0.2s;
        }
        input:focus { border-color: var(--primary); background: white; box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }
        label { display: block; margin-bottom: 6px; font-weight: 500; color: #374151; font-size: 0.9rem; }
        
        .link-text { color: var(--primary); font-size: 0.85rem; cursor: pointer; text-decoration: none; display: inline-block; margin-top: 5px; }
        .link-text:hover { text-decoration: underline; }

        /* --- FULL SCREEN OVERLAYS --- */
        .fullscreen-overlay {
            position: fixed; inset: 0; background: white; z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px;
        }
        .auth-box { width: 100%; max-width: 400px; text-align: center; }
        .auth-tabs { display: flex; background: #f3f4f6; padding: 4px; border-radius: 10px; margin-bottom: 20px; }
        .auth-tab { flex: 1; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: 600; color: var(--text-muted); }
        .auth-tab.active { background: white; color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        /* --- SIDEBAR --- */
        .sidebar {
            width: var(--sidebar-w); background: white; border-right: 1px solid #e5e7eb;
            display: flex; flex-direction: column; z-index: 50; transition: transform 0.3s ease;
        }
        .brand { height: var(--header-h); padding: 0 20px; font-size: 1.25rem; font-weight: 700; color: var(--primary); border-bottom: 1px solid #f3f4f6; display: flex; align-items: center; gap: 10px; }
        .menu { padding: 20px; flex: 1; }
        .menu-item {
            display: flex; align-items: center; gap: 12px; padding: 12px 15px;
            color: var(--text-muted); border-radius: 8px; cursor: pointer; margin-bottom: 5px; font-weight: 500;
        }
        .menu-item:hover { background: #f3f4f6; color: var(--text-main); }
        .menu-item.active { background: #eef2ff; color: var(--primary); }
        .user-mini { padding: 15px; border-top: 1px solid #e5e7eb; display: flex; align-items: center; gap: 10px; font-size: 0.85rem; }
        .user-mini img { width: 32px; height: 32px; border-radius: 50%; background: #ddd; object-fit: cover; }

        /* --- MAIN AREA --- */
        .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .header {
            height: var(--header-h); background: white; border-bottom: 1px solid #e5e7eb;
            padding: 0 20px; display: flex; align-items: center; justify-content: space-between;
        }
        .hamburger { display: none; font-size: 1.2rem; cursor: pointer; color: var(--text-muted); }
        .content { flex: 1; overflow-y: auto; padding: 20px; }

        /* --- CARDS & FORMS --- */
        .card { background: white; border-radius: var(--radius); padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); margin-bottom: 20px; border: 1px solid #f3f4f6; }
        .section-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 15px; color: var(--text-main); }
        
        .logo-upload-area {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            border: 2px dashed #d1d5db; border-radius: var(--radius); padding: 20px;
            cursor: pointer; transition: 0.2s; background: #f9fafb; margin-bottom: 20px;
        }
        .logo-upload-area:hover { border-color: var(--primary); background: #eef2ff; }
        .logo-preview { width: 80px; height: 80px; object-fit: contain; margin-bottom: 10px; border-radius: 50%; border: 1px solid #ddd; background: white; }

        /* --- INPUT TABLE (Dashboard) --- */
        .bill-items { width: 100%; border-collapse: separate; border-spacing: 0 8px; }
        .bill-item-row td { background: #f9fafb; padding: 8px; border-top: 1px solid #e5e7eb; border-bottom: 1px solid #e5e7eb; vertical-align: middle; }
        .bill-item-row td:first-child { border-left: 1px solid #e5e7eb; border-radius: 8px 0 0 8px; }
        .bill-item-row td:last-child { border-right: 1px solid #e5e7eb; border-radius: 0 8px 8px 0; }
        
        .bill-items input { padding: 8px; font-size: 0.85rem; }
        
        .total-section {
            background: #eef2ff; border: 1px solid #c7d2fe; border-radius: 12px;
            padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px;
        }

        /* --- PROFESSIONAL INVOICE PREVIEW --- */
        #preview-modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 100;
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
            overflow-y: auto; padding: 20px; backdrop-filter: blur(8px);
        }
        .paper {
            width: 100%; max-width: 750px; background: white; min-height: 900px;
            padding: 40px; position: relative; box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            margin-bottom: 80px; border-radius: 4px;
        }
        
        .inv-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 40px; }
        .inv-logo-box { display: flex; align-items: center; gap: 15px; }
        .inv-logo-box img { width: 80px; height: 80px; object-fit: contain; }
        .inv-biz-details h1 { font-size: 1.4rem; color: var(--text-main); text-transform: uppercase; margin: 0 0 5px 0; letter-spacing: 0.5px; }
        .inv-biz-details p { font-size: 0.85rem; color: #666; margin: 2px 0; line-height: 1.4; max-width: 250px; }
        
        .inv-meta { text-align: right; }
        .inv-title { font-size: 2.2rem; font-weight: 800; color: var(--primary); letter-spacing: 1px; margin-bottom: 10px; }
        .inv-meta-row { font-size: 0.9rem; margin-bottom: 4px; }
        .inv-meta-row span { font-weight: 600; color: var(--text-main); }

        .inv-bill-to { 
            background: #f8fafc; border-left: 4px solid var(--primary); 
            padding: 15px 20px; border-radius: 0 8px 8px 0; margin-bottom: 30px; 
            width: 60%;
        }
        .inv-label { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; font-weight: 600; }
        .inv-client-name { font-size: 1.1rem; font-weight: 700; color: var(--text-main); margin-bottom: 2px; }
        
        .inv-table { width: 100%; border-collapse: collapse; margin-bottom: 30px; }
        .inv-table th { 
            background: var(--primary); color: white; padding: 12px 15px; 
            text-align: left; font-size: 0.85rem; text-transform: uppercase; 
            font-weight: 600; letter-spacing: 0.5px;
        }
        .inv-table th:last-child { text-align: right; }
        .inv-table td { padding: 12px 15px; border-bottom: 1px solid #e2e8f0; color: #334155; font-size: 0.95rem; }
        .inv-table td:last-child { text-align: right; font-family: monospace; font-size: 1rem; }
        .inv-table tr:nth-child(even) { background-color: #f8fafc; }
        
        .inv-footer { display: flex; justify-content: space-between; align-items: flex-end; margin-top: 40px; }
        .inv-summary { width: 40%; }
        .inv-sum-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e2e8f0; }
        .inv-sum-row.total { 
            border-top: 2px solid var(--primary); border-bottom: none; 
            margin-top: 10px; padding-top: 15px; 
            color: var(--primary); font-weight: 700; font-size: 1.2rem;
        }
        
        .inv-terms { margin-top: 50px; padding-top: 20px; border-top: 1px solid #e2e8f0; font-size: 0.8rem; color: #94a3b8; text-align: center; }

        .action-dock {
            position: fixed; bottom: 20px; background: white; padding: 10px 20px;
            border-radius: 50px; display: flex; gap: 10px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            z-index: 101; flex-wrap: wrap; justify-content: center;
        }

        /* --- TOAST --- */
        #toast {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(100px);
            background: #333; color: white; padding: 10px 20px; border-radius: 50px;
            font-size: 0.9rem; transition: 0.3s; z-index: 200; opacity: 0;
        }
        #toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

        @media (max-width: 768px) {
            .sidebar { position: fixed; top: 0; bottom: 0; left: -100%; width: 280px; box-shadow: 5px 0 15px rgba(0,0,0,0.1); }
            .sidebar.open { left: 0; }
            .hamburger { display: block; }
            .grid-2 { grid-template-columns: 1fr; }
            .content { padding: 15px; }
            .paper { zoom: 0.55; width: 100%; margin: 0 auto 100px auto; }
            .action-dock { bottom: 10px; width: 90%; padding: 10px; border-radius: 15px; }
            .action-dock .btn { padding: 8px 12px; font-size: 0.8rem; flex: 1; }
        }

        @media print {
            body > *:not(#preview-modal) { display: none; }
            #preview-modal { position: absolute; background: white; padding: 0; overflow: visible; }
            .paper { box-shadow: none; margin: 0; width: 100%; zoom: 1; }
            .action-dock, .close-preview-btn { display: none !important; }
        }
    </style>
</head>
<body>

    <div id="auth-screen" class="fullscreen-overlay">
        <div class="auth-box">
            <h2 style="margin-bottom: 10px;">Billing App</h2>
            <p style="color: #6b7280; margin-bottom: 20px;">Professional Invoice Maker</p>
            <div class="auth-tabs">
                <div class="auth-tab active" onclick="switchAuth('login')">Login</div>
                <div class="auth-tab" onclick="switchAuth('register')">Register</div>
            </div>
            <div class="card" style="text-align: left;">
                <label>Email Address</label>
                <input type="email" id="auth-email" placeholder="name@business.com">
                <br>
                <label style="margin-top: 10px;">Password</label>
                <input type="password" id="auth-pass" placeholder="••••••••">
                <div id="forgot-pass-container" style="text-align: right;">
                    <span class="link-text" onclick="handleResetPassword()">Forgot Password?</span>
                </div>
                <button class="btn btn-dark w-100" style="margin-top: 20px;" onclick="handleAuth()">
                    <span id="auth-btn-text">Login</span> <i class="fa-solid fa-arrow-right"></i>
                </button>
                <p id="auth-msg" style="color: red; font-size: 0.85rem; margin-top: 10px; text-align: center;"></p>
            </div>
        </div>
    </div>

    <div id="verify-screen" class="fullscreen-overlay hidden">
        <div class="auth-box">
            <div style="width: 60px; height: 60px; background: #fff7ed; color: #f97316; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; margin: 0 auto 20px;">
                <i class="fa-solid fa-envelope"></i>
            </div>
            <h2>Verify Email</h2>
            <p style="color: #6b7280; margin-bottom: 20px; line-height: 1.5;">Check email: <b id="verify-email-display"></b></p>
            <button class="btn btn-primary w-100" onclick="location.reload()">I Verified, Continue</button>
            <div style="margin-top: 15px;">
                <span class="link-text" onclick="resendVerification()">Resend Link</span>
                <span style="color:#ddd; margin:0 10px;">|</span>
                <span class="link-text" style="color: #ef4444;" onclick="logout()">Logout</span>
            </div>
        </div>
    </div>

    <div id="onboarding-screen" class="fullscreen-overlay hidden">
        <div class="auth-box" style="max-width: 500px;">
            <h2 style="margin-bottom: 15px;">Setup Business</h2>
            <div class="card" style="text-align: left; max-height: 70vh; overflow-y: auto;">
                <div class="logo-upload-area" onclick="document.getElementById('setup-logo-file').click()">
                    <img src="https://via.placeholder.com/80?text=Logo" id="setup-logo-preview" class="logo-preview">
                    <div style="color: var(--primary); font-size: 0.9rem;">Tap to Upload Logo</div>
                    <input type="file" id="setup-logo-file" class="hidden" accept="image/*" onchange="previewLogo(this, 'setup-logo-preview')">
                </div>
                <label>Business Name <span style="color:red">*</span></label>
                <input type="text" id="setup-name" placeholder="e.g. Mishra Electronics">
                <label style="margin-top: 15px;">Phone Number</label>
                <input type="text" id="setup-phone" placeholder="+91...">
                <label style="margin-top: 15px;">Shop Address</label>
                <textarea id="setup-addr" rows="2" placeholder="Address..."></textarea>
                <label style="margin-top: 15px;">UPI ID</label>
                <input type="text" id="setup-upi" placeholder="e.g. name@oksbi">
            </div>
            <button class="btn btn-primary w-100" onclick="completeSetup()">Save & Continue</button>
            <div class="text-center mt-2"><span class="link-text" style="color: #666;" onclick="logout()">Logout</span></div>
        </div>
    </div>

    <div id="app-container" class="hidden" style="display: flex; width: 100%; height: 100%;">
        <nav class="sidebar" id="sidebar">
            <div class="brand"><i class="fa-solid fa-layer-group"></i> ProInvoice</div>
            <div class="menu">
                <div class="menu-item active" onclick="navTo('dashboard')"><i class="fa-solid fa-house"></i> Dashboard</div>
                <div class="menu-item" onclick="navTo('profile')"><i class="fa-solid fa-gear"></i> Settings</div>
            </div>
            <div class="user-mini">
                <img src="https://via.placeholder.com/32" id="mini-logo">
                <div style="flex: 1; overflow: hidden;">
                    <div id="mini-name" style="font-weight: 600; white-space: nowrap;">Loading...</div>
                    <div id="mini-email" style="color: #888; font-size: 0.75rem;">user@mail.com</div>
                </div>
                <i class="fa-solid fa-right-from-bracket" style="cursor: pointer; color: #ef4444;" onclick="logout()"></i>
            </div>
        </nav>

        <main class="main">
            <header class="header">
                <div class="flex" style="gap: 15px;">
                    <i class="fa-solid fa-bars hamburger" onclick="toggleSidebar()"></i>
                    <h3 id="page-title">New Invoice</h3>
                </div>
                <div class="flex"><span style="font-size: 0.9rem; color: #666;" id="current-date"></span></div>
            </header>

            <div class="content">
                <div id="view-dashboard">
                    <div class="card">
                        <div class="section-title"><i class="fa-regular fa-user"></i> Customer Info</div>
                        <div class="grid-2">
                            <div><label>Name</label><input type="text" id="cust-name" placeholder="John Doe"></div>
                            <div><label>Contact / Vehicle</label><input type="text" id="cust-phone" placeholder="Details..."></div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="section-title" style="margin-bottom: 5px;">Items</div>
                        <table class="bill-items">
                            <thead>
                                <tr style="text-align:left; color:#888; font-size:0.85rem;">
                                    <th style="padding:0 0 10px 10px;">Item</th>
                                    <th style="padding:0 0 10px 0; width:70px;">Rate</th>
                                    <th style="padding:0 0 10px 0; width:60px;">Qty</th>
                                    <th style="padding:0 0 10px 0; width:80px;">Amount</th>
                                    <th style="width:30px;"></th>
                                </tr>
                            </thead>
                            <tbody id="items-list"></tbody>
                        </table>
                        <button class="btn btn-dashed w-100" style="margin-top: 15px;" onclick="addItem()">
                            <i class="fa-solid fa-plus"></i> Add New Item
                        </button>
                    </div>

                    <div class="total-section">
                        <span style="font-weight: 600; color: var(--primary-dark);">Total Payable</span>
                        <span style="font-size: 1.5rem; font-weight: 700; color: var(--primary);">₹ <span id="dash-total">0</span></span>
                    </div>

                    <button class="btn btn-primary w-100" style="padding: 15px; font-size: 1.1rem; margin-bottom: 30px;" onclick="generateBill()">Generate Invoice</button>
                </div>

                <div id="view-profile" class="hidden">
                    <div class="card">
                        <div class="section-title">Edit Business Profile</div>
                        <div class="logo-upload-area" onclick="document.getElementById('prof-logo-file').click()">
                            <img src="https://via.placeholder.com/80?text=Logo" id="prof-logo-preview" class="logo-preview">
                            <div style="color: var(--primary);">Change Logo</div>
                            <input type="file" id="prof-logo-file" class="hidden" accept="image/*" onchange="previewLogo(this, 'prof-logo-preview')">
                        </div>
                        <div class="grid-2" style="margin-top: 20px;">
                            <div><label>Business Name</label><input type="text" id="prof-name"></div>
                            <div><label>Phone</label><input type="text" id="prof-phone"></div>
                        </div>
                        <label style="margin-top: 10px;">Address</label>
                        <textarea id="prof-address" rows="3"></textarea>
                        <label style="margin-top: 10px;">UPI ID</label>
                        <input type="text" id="prof-upi">
                    </div>
                    <button class="btn btn-success w-100" onclick="saveProfile()">Update Profile</button>
                </div>
            </div>
        </main>
    </div>

    <div id="preview-modal" class="hidden">
        <button class="btn btn-dark close-preview-btn" style="position: fixed; top: 20px; right: 20px; z-index: 102;" onclick="closePreview()">Close</button>
        
        <div class="paper" id="invoice-paper">
            <div class="inv-header">
                <div class="inv-logo-box">
                    <img id="bill-logo" src="" style="display: none;">
                    <div class="inv-biz-details">
                        <h1 id="bill-biz-name">Business Name</h1>
                        <p id="bill-biz-address">Address Line 1</p>
                        <p id="bill-biz-phone">Phone: +91 0000000000</p>
                    </div>
                </div>
                <div class="inv-meta">
                    <div class="inv-title">INVOICE</div>
                    <div class="inv-meta-row">Inv No: <span id="bill-no">#0000</span></div>
                    <div class="inv-meta-row">Date: <span id="bill-date">DD/MM/YYYY</span></div>
                </div>
            </div>
            
            <div class="inv-bill-to">
                <div class="inv-label">Billed To:</div>
                <div class="inv-client-name" id="bill-cust-name">Client Name</div>
                <div style="color: #64748b;" id="bill-cust-contact">Contact Info</div>
            </div>

            <table class="inv-table">
                <thead>
                    <tr>
                        <th style="width: 40%;">Item</th>
                        <th style="text-align: right;">Rate</th>
                        <th style="text-align: right;">Qty</th>
                        <th style="text-align: right;">Total</th>
                    </tr>
                </thead>
                <tbody id="bill-tbody"></tbody>
            </table>

            <div class="inv-footer">
                <div style="text-align: center;">
                    <div id="bill-qr" style="border: 1px solid #e2e8f0; padding: 5px; border-radius: 8px; display: inline-block;"></div>
                    <div style="font-size: 0.7rem; color: #64748b; margin-top: 5px;">Scan to Pay via UPI</div>
                </div>
                <div class="inv-summary">
                    <div class="inv-sum-row total">
                        <span>Total</span>
                        <span>₹<span id="bill-final-total">0</span></span>
                    </div>
                    <div style="margin-top: 40px; border-top: 1px solid #000; padding-top: 5px; text-align: right; font-size: 0.85rem;">Authorized Signature</div>
                </div>
            </div>
            <div class="inv-terms">Thank you for your business!</div>
        </div>

        <div class="action-dock">
            <button class="btn btn-outline" onclick="downloadImage()"><i class="fa-regular fa-image"></i> JPG</button>
            <button class="btn btn-danger" onclick="downloadPDF()"><i class="fa-solid fa-file-pdf"></i> PDF</button>
            <button class="btn btn-success" onclick="shareWhatsApp()"><i class="fa-brands fa-whatsapp"></i> Share</button>
            <button class="btn btn-dark" onclick="window.print()"><i class="fa-solid fa-print"></i> Print</button>
        </div>
    </div>

    <div id="toast">Notification</div>

    <script>
        // FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyDOPErXM1g4vdmiVdau67U7vGRsmbtMMhE",
            authDomain: "white-drack-fd1ee.firebaseapp.com",
            databaseURL: "https://white-drack-fd1ee-default-rtdb.firebaseio.com",
            projectId: "white-drack-fd1ee",
            storageBucket: "white-drack-fd1ee.firebasestorage.app",
            messagingSenderId: "151227903888",
            appId: "1:151227903888:web:02a2d7ab14f7d1e152cd15"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let currentUser = null;
        let authMode = 'login';
        let userProfile = {};
        document.getElementById('current-date').innerText = new Date().toLocaleDateString();

        // AUTH & SETUP LOGIC
        auth.onAuthStateChanged(async (user) => {
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('verify-screen').classList.add('hidden');
            document.getElementById('onboarding-screen').classList.add('hidden');
            document.getElementById('app-container').classList.add('hidden');

            if (user) {
                currentUser = user;
                if (!user.emailVerified) {
                    document.getElementById('verify-email-display').innerText = user.email;
                    document.getElementById('verify-screen').classList.remove('hidden');
                    return; 
                }
                document.getElementById('mini-email').innerText = user.email;
                const doc = await db.collection('users').doc(user.uid).get();
                if (doc.exists && doc.data().businessName) {
                    userProfile = doc.data();
                    loadProfileData();
                    document.getElementById('app-container').classList.remove('hidden');
                    if(document.getElementById('items-list').children.length === 0) addItem();
                } else {
                    document.getElementById('onboarding-screen').classList.remove('hidden');
                }
            } else {
                currentUser = null;
                document.getElementById('auth-screen').classList.remove('hidden');
            }
        });

        function switchAuth(mode) {
            authMode = mode;
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('auth-btn-text').innerText = mode === 'login' ? 'Login' : 'Create Account';
            const fp = document.getElementById('forgot-pass-container');
            fp.style.display = (mode === 'register') ? 'none' : 'block';
        }

        function handleAuth() {
            const email = document.getElementById('auth-email').value;
            const pass = document.getElementById('auth-pass').value;
            const msg = document.getElementById('auth-msg');
            msg.innerText = "";
            if(!email || !pass) return msg.innerText = "Please fill all fields";
            
            if (authMode === 'login') {
                auth.signInWithEmailAndPassword(email, pass).catch(e => msg.innerText = e.message);
            } else {
                auth.createUserWithEmailAndPassword(email, pass).then((userCredential) => {
                    userCredential.user.sendEmailVerification();
                    showToast("Verification email sent!");
                }).catch(e => msg.innerText = e.message);
            }
        }

        function handleResetPassword() {
            const email = document.getElementById('auth-email').value;
            if(!email) return alert("Please enter your email first.");
            auth.sendPasswordResetEmail(email).then(() => alert("Reset link sent!")).catch(e => alert(e.message));
        }

        function resendVerification() {
            if(currentUser) currentUser.sendEmailVerification().then(() => showToast("Link resent!"));
        }

        function logout() { auth.signOut(); location.reload(); }

        function completeSetup() {
            const name = document.getElementById('setup-name').value;
            const phone = document.getElementById('setup-phone').value;
            const addr = document.getElementById('setup-addr').value;
            const upi = document.getElementById('setup-upi').value;
            const logoSrc = document.getElementById('setup-logo-preview').src;
            const finalLogo = logoSrc.includes('placeholder') ? '' : logoSrc;

            if(!name) return alert("Business Name is required");

            const data = { businessName: name, phone, address: addr, upiId: upi, logo: finalLogo };
            db.collection('users').doc(currentUser.uid).set(data, { merge: true }).then(() => {
                userProfile = data;
                loadProfileData();
                document.getElementById('onboarding-screen').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                addItem();
            });
        }

        function loadProfileData() {
            document.getElementById('mini-name').innerText = userProfile.businessName;
            document.getElementById('prof-name').value = userProfile.businessName || '';
            document.getElementById('prof-phone').value = userProfile.phone || '';
            document.getElementById('prof-address').value = userProfile.address || '';
            document.getElementById('prof-upi').value = userProfile.upiId || '';
            if(userProfile.logo) {
                document.getElementById('mini-logo').src = userProfile.logo;
                document.getElementById('prof-logo-preview').src = userProfile.logo;
            }
        }

        function saveProfile() {
            const name = document.getElementById('prof-name').value;
            const phone = document.getElementById('prof-phone').value;
            const addr = document.getElementById('prof-address').value;
            const upi = document.getElementById('prof-upi').value;
            const logoSrc = document.getElementById('prof-logo-preview').src;
            const finalLogo = logoSrc.includes('placeholder') ? (userProfile.logo || '') : logoSrc;

            const data = { businessName: name, phone, address: addr, upiId: upi, logo: finalLogo };
            db.collection('users').doc(currentUser.uid).set(data, { merge: true }).then(() => {
                userProfile = data;
                loadProfileData();
                showToast("Profile Updated!");
            });
        }

        function previewLogo(input, imgId) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                if(file.size > 500000) return alert("Image too large (Max 500KB)");
                const reader = new FileReader();
                reader.onload = function(e) { document.getElementById(imgId).src = e.target.result; }
                reader.readAsDataURL(file);
            }
        }

        // NAV & UI
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }
        function navTo(page) {
            document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
            event.currentTarget.classList.add('active');
            document.getElementById('view-dashboard').classList.add('hidden');
            document.getElementById('view-profile').classList.add('hidden');
            document.getElementById(`view-${page}`).classList.remove('hidden');
            document.getElementById('page-title').innerText = page === 'dashboard' ? 'New Invoice' : 'Settings';
            document.getElementById('sidebar').classList.remove('open');
        }
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg; t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        // --- NEW BILLING LOGIC WITH RATE & QTY ---
        function addItem() {
            const tr = document.createElement('tr');
            tr.className = 'bill-item-row';
            tr.innerHTML = `
                <td><input type="text" placeholder="Item" class="i-desc"></td>
                <td style="width:70px"><input type="number" placeholder="0" class="i-rate" oninput="calcRow(this)"></td>
                <td style="width:60px"><input type="number" placeholder="1" class="i-qty" oninput="calcRow(this)"></td>
                <td style="width:80px"><input type="number" placeholder="0" class="i-amt" readonly tabindex="-1"></td>
                <td style="width:30px; text-align:center;"><i class="fa-solid fa-trash" style="color:#ef4444; cursor:pointer;" onclick="deleteRow(this)"></i></td>
            `;
            document.getElementById('items-list').appendChild(tr);
        }

        function calcRow(element) {
            const row = element.closest('tr');
            const rate = parseFloat(row.querySelector('.i-rate').value) || 0;
            const qty = parseFloat(row.querySelector('.i-qty').value) || 0;
            const amt = rate * qty;
            row.querySelector('.i-amt').value = amt;
            calcTotal();
        }

        function calcTotal() {
            let total = 0;
            document.querySelectorAll('.i-amt').forEach(el => total += Number(el.value));
            document.getElementById('dash-total').innerText = total;
            return total;
        }

        function deleteRow(btn) {
            btn.closest('tr').remove();
            calcTotal();
        }

        function generateBill() {
            const total = calcTotal();
            if(total <= 0) return showToast("Add items & details");
            
            document.getElementById('bill-biz-name').innerText = userProfile.businessName;
            document.getElementById('bill-biz-address').innerText = userProfile.address;
            document.getElementById('bill-biz-phone').innerText = userProfile.phone ? "Phone: " + userProfile.phone : "";
            
            const logo = document.getElementById('bill-logo');
            if(userProfile.logo) { logo.src = userProfile.logo; logo.style.display = 'block'; }
            else logo.style.display = 'none';

            document.getElementById('bill-cust-name').innerText = document.getElementById('cust-name').value || "Cash Customer";
            document.getElementById('bill-cust-contact').innerText = document.getElementById('cust-phone').value || "";
            document.getElementById('bill-date').innerText = new Date().toLocaleDateString();
            document.getElementById('bill-no').innerText = Math.floor(1000 + Math.random() * 9000);

            const tbody = document.getElementById('bill-tbody');
            tbody.innerHTML = "";
            document.querySelectorAll('.bill-item-row').forEach(row => {
                const d = row.querySelector('.i-desc').value;
                const r = row.querySelector('.i-rate').value;
                const q = row.querySelector('.i-qty').value;
                const a = row.querySelector('.i-amt').value;
                if(d) {
                    tbody.innerHTML += `
                        <tr>
                            <td>${d}</td>
                            <td style="text-align: right;">${r}</td>
                            <td style="text-align: right;">${q}</td>
                            <td style="text-align: right;">${a}</td>
                        </tr>
                    `;
                }
            });
            document.getElementById('bill-final-total').innerText = total;

            const qrDiv = document.getElementById('bill-qr');
            qrDiv.innerHTML = "";
            if(userProfile.upiId) {
                const qr = qrcode(0, 'M');
                qr.addData(`upi://pay?pa=${userProfile.upiId}&pn=${encodeURIComponent(userProfile.businessName)}&am=${total}&cu=INR`);
                qr.make();
                qrDiv.innerHTML = qr.createImgTag(3);
            } else {
                qrDiv.innerHTML = "<span style='color:#ccc; font-size:0.8rem;'>No UPI ID</span>";
            }

            document.getElementById('preview-modal').classList.remove('hidden');
        }

        function closePreview() { document.getElementById('preview-modal').classList.add('hidden'); }

        function downloadImage() {
            html2canvas(document.getElementById("invoice-paper"), {scale:2, useCORS: true}).then(c => {
                const a = document.createElement("a");
                a.download = "Invoice.jpg"; a.href = c.toDataURL("image/jpeg", 0.9); a.click();
            });
        }
        function downloadPDF() {
            const { jsPDF } = window.jspdf;
            html2canvas(document.getElementById("invoice-paper"), {scale:2, useCORS: true}).then(c => {
                const pdf = new jsPDF('p', 'mm', 'a4');
                const w = pdf.internal.pageSize.getWidth();
                const h = c.height * w / c.width;
                pdf.addImage(c.toDataURL('image/png'), 'PNG', 0, 0, w, h);
                pdf.save("Invoice.pdf");
            });
        }
        function shareWhatsApp() {
            const txt = `Invoice Total: ₹${document.getElementById('dash-total').innerText}`;
            window.open(`https://wa.me/?text=${encodeURIComponent(txt)}`);
        }
    </script>
</body>
</html>
